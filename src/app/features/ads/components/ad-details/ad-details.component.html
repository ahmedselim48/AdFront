<div class="ad-details-container" *ngIf="ad; else loadingTemplate">
  <!-- Ad Header -->
  <div class="ad-header">
    <div class="ad-title-section">
      <h1 class="ad-title">{{ ad.title }}</h1>
      <div class="ad-meta">
        <span class="ad-price">{{ formatPrice(ad.price) }}</span>
        <span class="ad-location">{{ ad.location }}</span>
        <span class="ad-date">{{ formatDate(ad.createdAt) }}</span>
      </div>
    </div>
    <div class="ad-actions" *ngIf="isOwner">
      <button class="btn btn-secondary" (click)="editAd()">
        <i class="icon-edit"></i> تعديل
      </button>
      <button class="btn btn-danger" (click)="deleteAd()">
        <i class="icon-trash"></i> حذف
      </button>
      <button class="btn btn-info" (click)="toggleAnalytics()">
        <i class="icon-chart"></i> {{ showAnalytics ? 'إخفاء التحليلات' : 'عرض التحليلات' }}
      </button>
    </div>
  </div>

  <!-- Ad Images -->
  <div class="ad-images" *ngIf="ad.images && ad.images.length > 0">
    <div class="image-gallery">
      <div class="main-image">
        <img [src]="ad.images[0] || '/assets/images/placeholder-ad.svg'" [alt]="ad.title" class="primary-image">
      </div>
      <div class="thumbnail-images" *ngIf="ad.images.length > 1">
        <img *ngFor="let image of ad.images.slice(1, 5)" 
             [src]="image" 
             [alt]="ad.title" 
             class="thumbnail">
      </div>
    </div>
  </div>

  <!-- Ad Owner Info -->
  <div class="ad-owner-info" *ngIf="ad.userName">
    <h3>المعلن</h3>
    <div class="owner-details">
      <a [routerLink]="['/u', ad.userId]" class="owner-link">
        <div class="owner-avatar">
          <img [src]="ad.userImageUrl || '/assets/images/default-avatar.svg'" [alt]="ad.userName" class="avatar-img">
        </div>
        <div class="owner-info">
          <span class="owner-name">{{ ad.userName }}</span>
          <span class="owner-label">عرض الملف الشخصي</span>
        </div>
      </a>
    </div>
  </div>

  <!-- Ad Description -->
  <div class="ad-description">
    <h3>الوصف</h3>
    <p>{{ ad.description }}</p>
  </div>

  <!-- Ad Keywords -->
  <div class="ad-keywords" *ngIf="ad.keywords && ad.keywords.length > 0">
    <h3>الكلمات المفتاحية</h3>
    <div class="keywords-list">
      <span *ngFor="let keyword of ad.keywords" class="keyword-tag">{{ keyword }}</span>
    </div>
  </div>

  <!-- Ad Stats -->
  <div class="ad-stats">
    <div class="stat-item">
      <i class="icon-eye"></i>
      <span>{{ ad.viewsCount }} مشاهدة</span>
    </div>
    <div class="stat-item">
      <i class="icon-heart"></i>
      <span>{{ ad.likesCount }} إعجاب</span>
    </div>
    <div class="stat-item">
      <i class="icon-message"></i>
      <span>{{ ad.commentsCount }} تعليق</span>
    </div>
  </div>

  <!-- Analytics Section -->
  <div class="analytics-section" *ngIf="showAnalytics && isOwner">
    <h3>التحليلات</h3>
    <div class="analytics-loading" *ngIf="performanceLoading">
      <div class="spinner"></div>
      <p>جاري تحميل التحليلات...</p>
    </div>
    <div class="analytics-content" *ngIf="!performanceLoading">
      <div class="performance-metrics">
        <div class="metric-card">
          <h4>إجمالي المشاهدات</h4>
          <span class="metric-value">{{ performance?.totalViews || ad.viewsCount || 0 }}</span>
        </div>
        <div class="metric-card">
          <h4>إجمالي النقرات</h4>
          <span class="metric-value">{{ performance?.totalClicks || ad.clicksCount || 0 }}</span>
        </div>
        <div class="metric-card">
          <h4>معدل النقر</h4>
          <span class="metric-value">{{ performance?.clickThroughRate || calculateCTR() | number:'1.2-2' }}%</span>
        </div>
        <div class="metric-card">
          <h4>معدل التحويل</h4>
          <span class="metric-value">{{ performance?.conversionRate || 0 | number:'1.2-2' }}%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="comments-section">
    <h3>التعليقات ({{ ad.commentsCount }})</h3>
    
    <!-- Add Comment Form -->
    <form [formGroup]="commentForm" (ngSubmit)="addComment()" class="comment-form">
      <div class="form-group">
        <textarea 
          formControlName="content" 
          placeholder="اكتب تعليقك هنا..."
          class="comment-input"
          rows="3">
        </textarea>
      </div>
      <button type="submit" 
              class="btn btn-primary" 
              [disabled]="commentForm.invalid">
        <i class="icon-send"></i> إرسال التعليق
      </button>
    </form>

    <!-- Comments List -->
    <div class="comments-loading" *ngIf="commentsLoading">
      <div class="spinner"></div>
      <p>جاري تحميل التعليقات...</p>
    </div>
    
    <div class="comments-list" *ngIf="!commentsLoading">
      <div *ngIf="comments.length === 0" class="no-comments">
        <p>لا توجد تعليقات بعد</p>
      </div>
      
      <div *ngFor="let comment of comments" class="comment-item">
        <div class="comment-header">
          <span class="comment-author">{{ comment.authorName }}</span>
          <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
        </div>
        <div class="comment-content">
          <p>{{ comment.content }}</p>
        </div>
        <div class="comment-actions" *ngIf="isOwner">
          <button class="btn btn-sm btn-danger" (click)="deleteComment(comment)">
            <i class="icon-trash"></i> حذف
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Information -->
  <div class="contact-section" *ngIf="ad.contactNumber && !isOwner">
    <h3>معلومات التواصل</h3>
    <div class="contact-info">
      <div class="contact-details">
        <span class="contact-number">{{ formatPhoneNumber(ad.contactNumber) }}</span>
        <span class="contact-method">{{ getContactMethodLabel(ad.contactMethod) }}</span>
      </div>
      <div class="contact-buttons">
        <button 
          class="btn btn-whatsapp" 
          (click)="openWhatsApp()">
          <i class="fab fa-whatsapp"></i>
          واتساب
        </button>
        <button 
          class="btn btn-call" 
          (click)="makeCall()">
          <i class="fas fa-phone"></i>
          اتصال
        </button>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="ad-action-buttons">
    <button class="btn btn-large" 
            [class.btn-primary]="!isLiked" 
            [class.btn-danger]="isLiked"
            (click)="toggleLike()">
      <i class="icon-heart"></i> 
      {{ isLiked ? 'إلغاء الإعجاب' : 'إعجاب' }} ({{ ad.likesCount }})
    </button>
    <button class="btn btn-secondary btn-large">
      <i class="icon-share"></i> مشاركة
    </button>
    <button class="btn btn-outline btn-large" (click)="contactSeller()" *ngIf="!isOwner">
      <i class="icon-message"></i> محادثة
    </button>
  </div>
</div>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="loading-container">
    <div class="spinner"></div>
    <p>جاري تحميل الإعلان...</p>
  </div>
</ng-template>