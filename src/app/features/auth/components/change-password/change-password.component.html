<div class="change-password-container">
  <div class="change-password-card">
    <mat-card class="change-password-mat-card">
      <mat-card-header>
        <div class="change-password-header">
          <div class="icon-wrapper">
            <lucide-icon name="lock" [size]="28" class="change-password-icon"></lucide-icon>
          </div>
          <h2 class="change-password-title">تغيير كلمة المرور</h2>
          <p class="change-password-subtitle">أدخل كلمة المرور الحالية والجديدة</p>
        </div>
      </mat-card-header>

      <mat-card-content>
        <!-- Success State -->
        <div *ngIf="isSuccess" class="success-state">
          <div class="success-icon-wrapper">
            <lucide-icon name="check-circle" [size]="56" class="success-icon"></lucide-icon>
          </div>
          <h3 class="success-title">تم تغيير كلمة المرور بنجاح!</h3>
          <p class="success-message">
            تم تغيير كلمة المرور بنجاح. يمكنك الآن استخدام كلمة المرور الجديدة لتسجيل الدخول.
          </p>
          <div class="success-actions">
            <button mat-raised-button color="primary" (click)="goToProfile()" class="profile-button">
              العودة للملف الشخصي
            </button>
            <button mat-stroked-button (click)="changePasswordAgain()" class="change-again-button">
              تغيير كلمة مرور أخرى
            </button>
          </div>
        </div>

        <!-- Form State -->
        <form *ngIf="!isSuccess" [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()" class="change-password-form">
          <!-- Current Password Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>كلمة المرور الحالية</mat-label>
            <input
              matInput
              [type]="showCurrentPassword ? 'text' : 'password'"
              formControlName="currentPassword"
              placeholder="أدخل كلمة المرور الحالية"
              autocomplete="current-password">
            <mat-icon matPrefix>
              <lucide-icon name="lock" [size]="20"></lucide-icon>
            </mat-icon>
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="toggleCurrentPasswordVisibility()"
              [attr.aria-label]="'إظهار كلمة المرور الحالية'">
              <mat-icon>
                <lucide-icon [name]="showCurrentPassword ? 'eye-off' : 'eye'" [size]="20"></lucide-icon>
              </mat-icon>
            </button>
            <mat-error *ngIf="changePasswordForm.get('currentPassword')?.hasError('required')">
              كلمة المرور الحالية مطلوبة
            </mat-error>
          </mat-form-field>

          <!-- New Password Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>كلمة المرور الجديدة</mat-label>
            <input
              matInput
              [type]="showNewPassword ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="أدخل كلمة المرور الجديدة"
              autocomplete="new-password">
            <mat-icon matPrefix>
              <lucide-icon name="lock" [size]="20"></lucide-icon>
            </mat-icon>
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="toggleNewPasswordVisibility()"
              [attr.aria-label]="'إظهار كلمة المرور الجديدة'">
              <mat-icon>
                <lucide-icon [name]="showNewPassword ? 'eye-off' : 'eye'" [size]="20"></lucide-icon>
              </mat-icon>
            </button>
            <mat-error *ngIf="changePasswordForm.get('newPassword')?.hasError('required')">
              كلمة المرور الجديدة مطلوبة
            </mat-error>
            <mat-error *ngIf="changePasswordForm.get('newPassword')?.hasError('minlength')">
              كلمة المرور يجب أن تكون 6 أحرف على الأقل
            </mat-error>
          </mat-form-field>

          <!-- Confirm Password Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>تأكيد كلمة المرور الجديدة</mat-label>
            <input
              matInput
              [type]="showConfirmPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="أعد إدخال كلمة المرور الجديدة"
              autocomplete="new-password">
            <mat-icon matPrefix>
              <lucide-icon name="lock" [size]="20"></lucide-icon>
            </mat-icon>
            <button
              mat-icon-button
              matSuffix
              type="button"
              (click)="toggleConfirmPasswordVisibility()"
              [attr.aria-label]="'إظهار تأكيد كلمة المرور'">
              <mat-icon>
                <lucide-icon [name]="showConfirmPassword ? 'eye-off' : 'eye'" [size]="20"></lucide-icon>
              </mat-icon>
            </button>
            <mat-error *ngIf="changePasswordForm.get('confirmPassword')?.hasError('required')">
              تأكيد كلمة المرور مطلوب
            </mat-error>
            <mat-error *ngIf="changePasswordForm.get('confirmPassword')?.hasError('mismatch')">
              كلمة المرور غير متطابقة
            </mat-error>
          </mat-form-field>

          <!-- Error Message -->
          <div class="error-message" *ngIf="errorMessage">
            <mat-icon class="error-icon">
              <lucide-icon name="alert-circle" [size]="18"></lucide-icon>
            </mat-icon>
            <span>{{ errorMessage }}</span>
          </div>

          <!-- Submit Button -->
          <button
            mat-raised-button
            color="primary"
            type="submit"
            class="change-password-button full-width"
            [disabled]="changePasswordForm.invalid || isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20" class="change-password-spinner"></mat-spinner>
            <span *ngIf="!isLoading">تغيير كلمة المرور</span>
          </button>

          <!-- Back to Profile -->
          <div class="back-to-profile">
            <button mat-button type="button" (click)="goToProfile()" class="back-link">
              <lucide-icon name="arrow-left" [size]="16" class="me-2"></lucide-icon>
              العودة للملف الشخصي
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>