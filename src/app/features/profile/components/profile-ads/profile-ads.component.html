<div class="profile-ads">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>جاري تحميل الإعلانات...</p>
  </div>

  <!-- Ads Content -->
  <div *ngIf="!isLoading" class="ads-content">
    <!-- Header Section -->
    <div class="ads-header">
      <div class="header-info">
        <h1>إعلاناتي</h1>
        <p>إدارة إعلاناتك ومتابعة أدائها</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="onCreateAd()">
          <lucide-icon name="plus" size="16"></lucide-icon>
          <span>إعلان جديد</span>
        </button>
        <button mat-icon-button (click)="onRefresh()">
          <lucide-icon name="refresh-cw" size="20"></lucide-icon>
        </button>
      </div>
    </div>

    <!-- Filters Section -->
    <mat-card class="filters-card">
      <mat-card-content>
        <form [formGroup]="filterForm" class="filters-form">
          <div class="filters-row">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>البحث في الإعلانات</mat-label>
              <input matInput 
                     formControlName="searchTerm"
                     placeholder="ابحث بالعنوان أو الوصف...">
              <mat-icon matPrefix>search</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="status-field">
              <mat-label>حالة الإعلان</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="price-field">
              <mat-label>السعر من</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="minPrice"
                     placeholder="0">
              <mat-icon matPrefix>dollar-sign</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="price-field">
              <mat-label>السعر إلى</mat-label>
              <input matInput 
                     type="number" 
                     formControlName="maxPrice"
                     placeholder="1000000">
              <mat-icon matPrefix>dollar-sign</mat-icon>
            </mat-form-field>

            <button mat-button type="button" (click)="onClearFilters()">
              <lucide-icon name="filter" size="16"></lucide-icon>
              <span>مسح الفلاتر</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Enhanced Stats Summary -->
    <div class="stats-summary" *ngIf="ads.length > 0">
      <div class="stat-item">
        <span class="stat-value">{{ ads.length }}</span>
        <span class="stat-label">إجمالي الإعلانات</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getPublishedAdsCount() }}</span>
        <span class="stat-label">منشور</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getDraftAdsCount() }}</span>
        <span class="stat-label">مسودة</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getTotalViews() }}</span>
        <span class="stat-label">إجمالي المشاهدات</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getTotalClicks() }}</span>
        <span class="stat-label">إجمالي النقرات</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getTotalLikes() }}</span>
        <span class="stat-label">إجمالي الإعجابات</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getClickThroughRate() }}%</span>
        <span class="stat-label">معدل النقر</span>
      </div>
      <div class="stat-item">
        <span class="stat-value">{{ getEngagementRate() }}%</span>
        <span class="stat-label">معدل التفاعل</span>
      </div>
    </div>

    <!-- Performance Insights -->
    <div class="performance-insights" *ngIf="ads.length > 0">
      <mat-card class="insights-card">
        <mat-card-header>
          <mat-card-title>رؤى الأداء</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="insights-grid">
            <div class="insight-item">
              <h4>أفضل إعلان أداءً</h4>
              <p *ngIf="getTopPerformingAd(); else noTopAd">
                {{ getTopPerformingAd()?.title }}
                <br>
                <small>{{ getTopPerformingAd()?.viewsCount }} مشاهدة</small>
              </p>
              <ng-template #noTopAd>
                <p>لا توجد بيانات كافية</p>
              </ng-template>
            </div>
            <div class="insight-item">
              <h4>الفئة الأكثر نشاطاً</h4>
              <p>{{ getTopCategory() }}</p>
            </div>
            <div class="insight-item">
              <h4>متوسط المشاهدات</h4>
              <p>{{ getAverageViewsPerAd() }} مشاهدة لكل إعلان</p>
            </div>
            <div class="insight-item">
              <h4>الإعلانات الحديثة</h4>
              <p>{{ getRecentAds().length }} إعلان في آخر 5</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Ads Grid -->
    <div class="ads-grid" *ngIf="getPaginatedAds().length > 0; else noAdsTemplate">
      <mat-card *ngFor="let ad of getPaginatedAds(); trackBy: trackByAdId" class="ad-card">
        <div class="ad-image">
          <img [src]="getAdImage(ad)" [alt]="ad.title" class="ad-thumbnail">
          <div class="ad-status">
            <mat-chip [color]="getStatusColor(ad.status)" selected>
              {{ getStatusLabel(ad.status) }}
            </mat-chip>
          </div>
        </div>

        <mat-card-content class="ad-content">
          <h3 class="ad-title">{{ ad.title }}</h3>
          <p class="ad-description">{{ (ad.description || '') | slice:0:100 }}{{ (ad.description?.length || 0) > 100 ? '...' : '' }}</p>
          
          <div class="ad-details">
            <div class="detail-item">
              <lucide-icon name="dollar-sign" size="14"></lucide-icon>
              <span>{{ formatPrice(ad.price) }}</span>
            </div>
            <div class="detail-item" *ngIf="ad.location">
              <lucide-icon name="map-pin" size="14"></lucide-icon>
              <span>{{ ad.location }}</span>
            </div>
            <div class="detail-item">
              <lucide-icon name="eye" size="14"></lucide-icon>
              <span>{{ ad.viewsCount || 0 }} مشاهدة</span>
            </div>
            <div class="detail-item">
              <lucide-icon name="heart" size="14"></lucide-icon>
              <span>{{ ad.likesCount || 0 }} إعجاب</span>
            </div>
            <div class="detail-item">
              <lucide-icon name="message-circle" size="14"></lucide-icon>
              <span>{{ ad.commentsCount || 0 }} تعليق</span>
            </div>
          </div>

          <div class="ad-meta">
            <span class="ad-category">{{ ad.categoryName }}</span>
            <span class="ad-date">{{ formatDate(ad.createdAt) }}</span>
          </div>
        </mat-card-content>

        <mat-card-actions class="ad-actions">
          <button mat-button (click)="onViewAd(ad)">
            <lucide-icon name="eye" size="16"></lucide-icon>
            <span>عرض</span>
          </button>
          
          <button mat-button (click)="onEditAd(ad)">
            <lucide-icon name="edit" size="16"></lucide-icon>
            <span>تعديل</span>
          </button>

          <button mat-button 
                  *ngIf="ad.status === 'Draft'" 
                  (click)="onPublishAd(ad)"
                  [disabled]="isSaving">
            <lucide-icon name="calendar" size="16"></lucide-icon>
            <span>نشر</span>
          </button>

          <button mat-icon-button [matMenuTriggerFor]="adMenu">
            <lucide-icon name="more-vertical" size="16"></lucide-icon>
          </button>

          <mat-menu #adMenu="matMenu">
            <button mat-menu-item (click)="onViewAd(ad)">
              <lucide-icon name="eye" size="16"></lucide-icon>
              <span>عرض التفاصيل</span>
            </button>
            <button mat-menu-item (click)="onEditAd(ad)">
              <lucide-icon name="edit" size="16"></lucide-icon>
              <span>تعديل</span>
            </button>
            <button mat-menu-item 
                    *ngIf="ad.status === 'Draft'" 
                    (click)="onPublishAd(ad)">
              <lucide-icon name="calendar" size="16"></lucide-icon>
              <span>نشر الإعلان</span>
            </button>
            <button mat-menu-item (click)="onDeleteAd(ad)" class="delete-action">
              <lucide-icon name="trash-2" size="16"></lucide-icon>
              <span>حذف</span>
            </button>
          </mat-menu>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- No Ads Template -->
    <ng-template #noAdsTemplate>
      <div class="no-ads">
        <div class="no-ads-content">
          <lucide-icon name="eye" size="64" class="no-ads-icon"></lucide-icon>
          <h3>لا توجد إعلانات</h3>
          <p>لم تقم بإنشاء أي إعلانات بعد. ابدأ بإنشاء إعلانك الأول!</p>
          <button mat-raised-button color="primary" (click)="onCreateAd()">
            <lucide-icon name="plus" size="16"></lucide-icon>
            <span>إنشاء إعلان جديد</span>
          </button>
        </div>
      </div>
    </ng-template>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button mat-button 
              [disabled]="currentPage === 1" 
              (click)="onPageChange(currentPage - 1)">
        السابق
      </button>
      
      <span class="page-info">
        صفحة {{ currentPage }} من {{ totalPages }}
      </span>
      
      <button mat-button 
              [disabled]="currentPage === totalPages" 
              (click)="onPageChange(currentPage + 1)">
        التالي
      </button>
    </div>
  </div>
</div>
