<section class="profile-wrap container">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="profile-card card glass">
      <div class="profile-info">
        <div class="avatar" aria-hidden="true">{{ (form.value.name || 'U').slice(0,1) }}</div>
        <div class="info">
          <h2 class="name">{{ form.value.name || '‚Äî' }}</h2>
          <div class="contact">
            <span class="pill email">{{ form.value.email || '‚Äî' }}</span>
            <span class="pill plan" [class]="'plan-' + form.value.plan">{{ form.value.plan | uppercase }}</span>
          </div>
          <p class="bio">{{ 'Create, manage, and optimize your ads with AI assistance.' }}</p>
        </div>
      </div>
      
      <!-- Header Quick Actions -->
      <div class="header-actions">
        <a routerLink="/ads" class="h-action">
          <span class="icon">üì¢</span>
          <span>{{ 'nav.ads' | t }}</span>
        </a>
        <a routerLink="/chat" class="h-action">
          <span class="icon">üí¨</span>
          <span>{{ 'nav.chat' | t }}</span>
          <span class="badge" *ngIf="unreadMessages > 0">{{ unreadMessages }}</span>
        </a>
        <a routerLink="/auth/change-password" class="h-action">
          <span class="icon">üîí</span>
          <span>{{ 'auth.changePassword' | t }}</span>
        </a>
      </div>

      <!-- Profile Stats -->
      <div class="profile-stats">
        <div class="stat-item">
          <div class="stat-number">{{ totalAds }}</div>
          <div class="stat-label">{{ 'profile.totalAds' | t }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ activeAds }}</div>
          <div class="stat-label">{{ 'profile.activeAds' | t }}</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ unreadMessages }}</div>
          <div class="stat-label">{{ 'profile.unreadMessages' | t }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Content Tabs -->
  <div class="profile-content">
    <div class="tabs">
      <button class="tab-button" [class.active]="activeTab === 'profile'" (click)="setActiveTab('profile')">
        <i class="icon">üë§</i>
        {{ 'profile.profile' | t }}
      </button>
      <button class="tab-button" [class.active]="activeTab === 'ads'" (click)="setActiveTab('ads')">
        <i class="icon">üìä</i>
        {{ 'profile.myAds' | t }}
      </button>
      <button class="tab-button" [class.active]="activeTab === 'chat'" (click)="setActiveTab('chat')">
        <i class="icon">üí¨</i>
        {{ 'profile.chat' | t }}
        <span class="badge" *ngIf="unreadMessages > 0">{{ unreadMessages }}</span>
      </button>
    </div>

    <!-- Profile Tab -->
    <div class="tab-content" *ngIf="activeTab === 'profile'">
      <div class="card glass">
        <h3>{{ 'profile.editProfile' | t }}</h3>
        <form [formGroup]="form" (ngSubmit)="save()" class="edit-form">
          <div class="form-row">
            <label>{{ 'common.name' | t }}
              <input type="text" formControlName="name" class="field-input" 
                     [class.error]="hasFieldError('name')" 
                     [class.success]="hasFieldSuccess('name')">
              <div class="field-error" *ngIf="hasFieldError('name')">{{ getFieldError('name') }}</div>
            </label>
            <label>{{ 'common.email' | t }}
              <input type="email" formControlName="email" class="field-input" [attr.disabled]="true">
              <small class="field-hint">{{ 'profile.emailCannotChange' | t }}</small>
            </label>
          </div>
          <div class="form-row">
            <label>{{ 'profile.plan' | t }}
              <select formControlName="plan" class="field-input">
                <option value="free">{{ 'plan.free' | t }}</option>
                <option value="pro">{{ 'plan.pro' | t }}</option>
                <option value="enterprise">{{ 'plan.enterprise' | t }}</option>
              </select>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="button primary" [disabled]="form.invalid || saving">
              <span *ngIf="saving" class="loading-spinner"></span>
              {{ saving ? ('common.saving' | t) : ('common.save' | t) }}
            </button>
            <a routerLink="/auth/change-password" class="button secondary">{{ 'auth.changePassword' | t }}</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Ads Tab in 2-column layout with chat sidebar -->
    <div class="tab-content" *ngIf="activeTab === 'ads'">
      <div class="grid-12">
        <div class="col-span-8">
          <div class="ads-section">
            <div class="ads-header">
              <h3>{{ 'profile.myAds' | t }}</h3>
              <div class="actions">
                <div class="filter-tabs" role="tablist">
                  <button class="filter-tab" [class.active]="filter==='all'" (click)="setFilter('all')">
                    {{ 'profile.all' | t }} ({{counts['all']}})
                  </button>
                  <button class="filter-tab" [class.active]="filter==='draft'" (click)="setFilter('draft')">
                    {{ 'profile.draft' | t }} ({{counts['draft']}})
                  </button>
                  <button class="filter-tab" [class.active]="filter==='scheduled'" (click)="setFilter('scheduled')">
                    {{ 'profile.scheduled' | t }} ({{counts['scheduled']}})
                  </button>
                  <button class="filter-tab" [class.active]="filter==='published'" (click)="setFilter('published')">
                    {{ 'profile.published' | t }} ({{counts['published']}})
                  </button>
                </div>
                <div class="view-controls">
                  <button class="view-btn" [class.active]="viewMode==='grid'" (click)="setView('grid')" title="Grid View">
                    <i class="icon">‚äû</i>
                  </button>
                  <button class="view-btn" [class.active]="viewMode==='list'" (click)="setView('list')" title="List View">
                    <i class="icon">‚ò∞</i>
                  </button>
                </div>
                <a routerLink="/ads" class="button primary">
                  <i class="icon">+</i>
                  {{ 'profile.newAd' | t }}
                </a>
              </div>
            </div>

            <div [ngClass]="{ 'ads-grid': viewMode==='grid', 'ads-list': viewMode==='list' }" *ngIf="!loadingAds; else loadingAdsTpl">
              <article class="ad-card" *ngFor="let ad of filteredAds">
                <header class="ad-head">
                  <span class="ad-icon">üì¢</span>
                  <h4>{{ ad.name }}</h4>
                  <span class="status" [attr.data-status]="ad.status">{{ ad.status }}</span>
                </header>
                <div class="ad-body">
                  <ng-container *ngIf="ad.variants && ad.variants.length; else noVar">
                    <div class="variant" *ngFor="let v of ad.variants">
                      <img *ngIf="v.imageUrl" [src]="v.imageUrl" alt="ad image" class="ad-image"/>
                      <div class="title">{{ v.title }}</div>
                      <p>{{ v.body }}</p>
                    </div>
                  </ng-container>
                  <ng-template #noVar><p class="no-variants">{{ 'profile.noVariants' | t }}</p></ng-template>
                </div>
                <footer class="ad-foot">
                  <span class="pill" *ngIf="ad.category">#{{ad.category}}</span>
                  <span class="pill" *ngIf="ad.price">{{ad.price | number:'1.0-0'}} {{ 'profile.currency' | t }}</span>
                  <span class="flex-spacer"></span>
                  <a class="button secondary" [routerLink]="['/chat']">
                    <i class="icon">üí¨</i>
                    {{ 'profile.chat' | t }}
                  </a>
                  <button type="button" class="button ghost" (click)="editAd(ad)">
                    <i class="icon">‚úèÔ∏è</i>
                    {{ 'common.edit' | t }}
                  </button>
                  <button type="button" class="button danger" (click)="deleteAd(ad)">
                    <i class="icon">üóëÔ∏è</i>
                    {{ 'common.delete' | t }}
                  </button>
                </footer>
              </article>
            </div>

            <ng-template #loadingAdsTpl>
              <div class="ads-grid">
                <article class="ad-card" *ngFor="let _ of [0,1,2]">
                  <div class="skeleton" style="height:96px;border-radius:12px"></div>
                </article>
              </div>
            </ng-template>
          </div>
        </div>
        <aside class="col-span-4">
          <div class="chat-section">
            <div class="chat-header">
              <h3>{{ 'profile.recentChats' | t }}</h3>
              <a routerLink="/chat" class="button primary">
                <i class="icon">üí¨</i>
                {{ 'profile.viewAllChats' | t }}
              </a>
            </div>
            <div class="chat-list" *ngIf="!loadingChats; else loadingChatsTplSide">
              <div class="chat-item" *ngFor="let conversation of recentChats" [routerLink]="['/chat', conversation.id]">
                <div class="chat-avatar">{{ (conversation.adTitle || 'C').slice(0,1) }}</div>
                <div class="chat-info">
                  <div class="chat-title">{{ conversation.adTitle || 'Untitled Chat' }}</div>
                  <div class="chat-preview">{{ conversation.lastMessage?.content || 'No messages yet' }}</div>
                </div>
                <div class="chat-meta">
                  <div class="chat-time">{{ conversation.lastMessageAt | date:'short' }}</div>
                  <span class="unread-badge" *ngIf="conversation.unreadMessageCount > 0">{{ conversation.unreadMessageCount }}</span>
                </div>
              </div>
            </div>
            <ng-template #loadingChatsTplSide>
              <div class="chat-list">
                <div class="chat-item" *ngFor="let _ of [0,1]">
                  <div class="skeleton avatar"></div>
                  <div class="skeleton content"></div>
                </div>
              </div>
            </ng-template>
          </div>
        </aside>
      </div>
    </div>

    <!-- Chat Tab -->
    <div class="tab-content" *ngIf="activeTab === 'chat'">
      <div class="chat-section">
        <div class="chat-header">
          <h3>{{ 'profile.recentChats' | t }}</h3>
          <a routerLink="/chat" class="button primary">
            <i class="icon">üí¨</i>
            {{ 'profile.viewAllChats' | t }}
          </a>
        </div>
        
        <div class="chat-list" *ngIf="!loadingChats; else loadingChatsTpl">
          <div class="chat-item" *ngFor="let conversation of recentChats" [routerLink]="['/chat', conversation.id]">
            <div class="chat-avatar">
              {{ (conversation.adTitle || 'C').slice(0,1) }}
            </div>
            <div class="chat-info">
              <div class="chat-title">{{ conversation.adTitle || 'Untitled Chat' }}</div>
              <div class="chat-preview">{{ conversation.lastMessage?.content || 'No messages yet' }}</div>
            </div>
            <div class="chat-meta">
              <div class="chat-time">{{ conversation.lastMessageAt | date:'short' }}</div>
              <span class="unread-badge" *ngIf="conversation.unreadMessageCount > 0">
                {{ conversation.unreadMessageCount }}
              </span>
            </div>
          </div>
          
          <div class="empty-state" *ngIf="recentChats.length === 0">
            <div class="empty-icon">üí¨</div>
            <h4>{{ 'profile.noChats' | t }}</h4>
            <p>{{ 'profile.noChatsDescription' | t }}</p>
            <a routerLink="/chat" class="button primary">{{ 'profile.startChat' | t }}</a>
          </div>
        </div>
        
        <ng-template #loadingChatsTpl>
          <div class="chat-list">
            <div class="chat-item" *ngFor="let _ of [0,1,2]">
              <div class="skeleton avatar"></div>
              <div class="skeleton content"></div>
            </div>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</section>
